# ドラッグ&ドロップ機能実装記録

## 実装日時
2025-08-08

## 概要
回答欄の文字をドラッグ&ドロップで自由に並び替えできる機能を実装。HTML5 Drag and Drop APIを使用し、直感的なユーザーインターフェースを実現。

## 技術仕様

### 使用技術
- HTML5 Drag and Drop API
- React DragEvent ハンドラー
- TypeScript strict mode
- Tailwind CSS for styling

### 状態管理
```typescript
// ドラッグ中の文字のインデックスを追跡
const [draggedIndex, setDraggedIndex] = useState<number | null>(null);

// ドロップ予定位置を視覚的に表示するためのインデックス
const [dragOverIndex, setDragOverIndex] = useState<number | null>(null);
```

### 主要イベントハンドラー

#### handleDragStart
- ドラッグ開始時の処理
- `dataTransfer.setData()` でドラッグデータを設定
- 回答済み状態では無効化

#### handleDragOver  
- ドラッグオーバー時の位置判定
- `e.preventDefault()` でドロップを有効化
- 自分自身への無効ドラッグを防止

#### handleDrop
- 配列操作でキャラクター順序変更
- インデックス調整ロジックで正確な挿入位置計算
- 状態リセット処理

#### handleDragLeave
- タイマーベースの遅延リセット (100ms)
- 高速マウス移動時のチラつき防止

## UI/UX 設計思想

### 透明ドロップゾーン
- 各文字の左側に6px幅の透明エリア配置
- `z-index: 10` で文字より前面に設定
- ユーザーには見えないが、ドラッグイベントは受け取る

### 視覚的フィードバック
- 青い縦線 (1px幅) でドロップ位置を明示
- `animate-pulse` で動的な視覚効果
- ドラッグ中文字の透明度変更 (opacity: 50%)

### イベント伝播制御
- `stopPropagation()` で重複判定を防止
- 各ドロップゾーンが独立して動作

## 配列操作ロジック

### インデックス調整の必要性
```javascript
// 例: [A, B, C, D] でBをDの位置に移動
// 1. Bを削除: [A, C, D] (Dのインデックスが3→2に変化)
// 2. 元のdropIndex=3だが、実際は2に挿入すべき
// 3. 条件: dropIndex > dragIndex なら -1 調整

let insertIndex = dropIndex;
if (dropIndex > dragIndex) {
  insertIndex = dropIndex - 1;
}
```

### 配列操作手順
1. 元配列のコピー作成
2. ドラッグ要素を削除 (`splice(dragIndex, 1)`)
3. 調整済みインデックスに挿入 (`splice(insertIndex, 0, draggedChar)`)
4. 状態更新と回答文字列の再生成

## パフォーマンス考慮

### 状態更新の最適化
- 必要最小限の再レンダリング
- 状態の適切な分離 (drag状態 vs ゲーム状態)

### メモリ効率
- イベントハンドラーの適切なクリーンアップ
- タイマーのメモリリーク防止

## 解決した課題

### 1. 最後尾ドロップ問題
- **問題**: 配列末尾への挿入ができない
- **解決**: 専用の最後尾ドロップゾーン追加

### 2. ドロップ判定の厳しさ
- **問題**: 正確な位置でないとドロップできない
- **解決**: 6px幅の透明ドロップゾーンで判定エリア拡大

### 3. 全て最後尾判定問題
- **問題**: どこにドラッグしても最後尾扱いになる
- **解決**: イベント伝播制御と個別ドロップゾーン実装

### 4. ドラッグリーブのチラつき
- **問題**: 高速マウス移動時の視覚的ノイズ
- **解決**: 100msタイマーによる遅延リセット

## コード品質

### TypeScript活用
- 厳密な型チェックでランタイムエラー防止
- DragEvent型の適切な使用

### アクセシビリティ考慮
- `userSelect: 'none'` でテキスト選択無効化
- 適切なカーソル表示 (`cursor-move`)

### テスタビリティ
- 純粋な配列操作関数として分離可能
- 状態とロジックの明確な分離

## 今後の拡張可能性

### アニメーション強化
- より滑らかなトランジション効果
- ドラッグ中の視覚的フィードバック向上

### タッチデバイス対応
- Touch Events APIとの併用
- モバイル最適化

### キーボードサポート
- 矢印キーによる並び替え
- アクセシビリティ向上

## 学習ポイント

### HTML5 Drag and Drop API
- `draggable` 属性の重要性
- `dataTransfer` オブジェクトの活用法
- イベントの適切な処理順序

### React状態管理
- 複数状態の協調動作
- useStateの効果的な使い分け

### UI/UXデザイン
- 見えないUI要素の効果的活用
- ユーザーストレス軽減の具体的手法

## 総括
複雑なドラッグ&ドロップ機能を、ユーザビリティを最優先に実装。技術的な制約をUI設計で解決し、直感的な操作感を実現。今後のインタラクティブ機能開発の基盤となる実装。